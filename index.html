<!doctype html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="utf-8" />
  <title>HR & Admin Dashboard - Global</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MSAL (global) -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:18px;
      margin-bottom:18px;
    }
    .nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:none; border:none;
      padding:10px 12px; border-radius:10px;
      cursor:pointer; color:#0f172a; font-weight:500;
    }
    .logo img{
      height:68px;    /* control size here */
      width:auto;
      display:block;
    }
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:270px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }
    /* ===== FIX PIE CHART OVERFLOW ===== */
.chart-wrapper{
  position:relative;
  width:100%;
  height:100%;
}

.chart-wrapper canvas{
  max-width:100% !important;
  max-height:100% !important;
}

/* ===== DASHBOARD GRID FIX ===== */
.dashboard-row{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:16px;
  margin-top:16px;
}

.dashboard-card{
  height:380px;
  display:flex;
  flex-direction:column;
}

.chart-wrapper{
  flex:1;
  position:relative;
}

/* Mobile responsive */
@media (max-width:1100px){
  .dashboard-row{
    grid-template-columns: 1fr;
  }
}

    .row { display:flex; gap:16px; align-items:flex-start; }
    .col-2 { display:flex; flex-direction:column; gap:16px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:13px; color:var(--muted); }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 14px;
      border-radius:10px; cursor:pointer;
      font-weight:600;
    }

    .btn-outline {
      background:#eef2ff;
      color:#1e293b;
      border:none;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:500;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }

    .summary-card {
      min-width:260px;
    }
    .summary-row {
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px solid #f1f5f9;
      font-size:13px;
    }

    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    @media (max-width:1100px){
      .row{flex-direction:column;}
      .summary-card{width:100%;}
    }
    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .kpi{min-width:140px;}
    }

    /* Profile layout */
    .profile-layout{
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .profile-card{
      flex:1;
      min-width:280px;
    }
    .profile-avatar{
      width:140px;
      height:140px;
      border-radius:50%;
      background:#eef2ff;
      overflow:hidden;
      margin-right:24px;
      flex-shrink:0;
    }
    .profile-avatar img{
      width:100%;height:100%;object-fit:cover;
    }
    .profile-grid{
      display:grid;
      grid-template-columns:120px 1fr;
      row-gap:6px;
      column-gap:12px;
      font-size:14px;
    }
    .profile-label{font-weight:600;color:#475569;}
    .qa-buttons{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    /* ========== Mobile menu (added) ========== */
    .hamburger { display:none; width:44px; height:36px; border-radius:8px;
      background:transparent; border:1px solid rgba(15,23,42,0.06);
      align-items:center; justify-content:center; cursor:pointer; padding:0;
    }
    .hamburger .bar { width:20px; height:2px; background:#0f172a; display:block; border-radius:2px; position:relative; }
    .hamburger .bar::before, .hamburger .bar::after { content:""; position:absolute; left:0; right:0; height:2px; background:#0f172a; border-radius:2px; }
    .hamburger .bar::before { top:-6px; } .hamburger .bar::after { top:6px; }

    .mobile-sidebar-backdrop {
      position:fixed; inset:0; background:rgba(10,15,25,0.35);
      z-index:1200; display:none;
    }
    .mobile-sidebar {
      position:fixed; top:0; left:0; height:100vh; width:260px; max-width:85%;
      background:rgba(255,255,255,0.98); padding:20px;
      box-shadow: 6px 0 30px rgba(2,6,23,0.2);
      transform:translateX(-110%); transition: transform .28s cubic-bezier(.2,.9,.3,1);
      z-index:1300; box-sizing:border-box; overflow:auto;
    }
    .mobile-sidebar.open { transform:translateX(0%); }
    .mobile-sidebar-backdrop.open { display:block; }

    @media (max-width:900px){
      .hamburger { display:flex; }
    }
    /* ========== end mobile menu ========== */

  </style>
</head>

<body>
<div id="root"></div>

<!-- ========= MSAL / GRAPH HELPER (NON-MODULE) ========= -->
<script>
  const CLIENT_ID    = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID    = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID     = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID      = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees:    "Employees",
    attendance:   "Attendance",
    leaves:       "Leaves",
    leaveCalc:    "Leave_Calculation",
    weeklyAgenda: "Weekly_Agenda"
  };

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: true
    }
  };

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  // NEW: do not auto-popup; try silent only and return null if not available
  async function getToken() {
    // Try to get cached account first
    let account = msalInstance.getAllAccounts()[0];

    if (!account) {
      // no account in cache - do not auto-open popup here.
      console.debug("[auth] No MSAL account found in cache.");
      return null;
    }

    try {
      // Attempt silent token acquisition (standard & recommended)
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return tokenResponse.accessToken;
    } catch (err) {
      // silent acquisition failed (expired / interaction required / same-site cookies blocked)
      // We will NOT auto-call loginPopup here (prevents unexpected prompt on refresh).
      console.warn("[auth] acquireTokenSilent failed:", err);
      return null;
    }
  }

  // small fetch-with-retry util used by auto-refresh
  async function fetchWithRetry(url, opts = {}, retries = 2, baseDelay = 600) {
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        const r = await fetch(url, opts);
        if (!r.ok) {
          const txt = await r.text().catch(()=>'');
          const err = new Error(`HTTP ${r.status} ${txt}`);
          err.status = r.status;
          throw err;
        }
        return r;
      } catch (err) {
        if (attempt === retries) throw err;
        const wait = baseDelay * Math.pow(2, attempt);
        console.warn(`fetchWithRetry attempt ${attempt+1} failed, retrying in ${wait}ms`, err);
        await new Promise(r=>setTimeout(r, wait));
      }
    }
  }

  // Fetch worksheet usedRange(valuesOnly=true) and convert to array of objects
  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    if (!token) {
      throw new Error("No access token available (silent acquisition failed).");
    }
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // escape single quotes inside sheet name by doubling them (Graph rule: worksheets('name'))
    const sheetNameEsc = ('' + tableName).replace(/'/g, "''");
    const url = `${base}/worksheets('${sheetNameEsc}')/usedRange(valuesOnly=true)`;

    const res = await fetchWithRetry(url, {
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: 'application/json'
      }
    }, 2, 600);

    const json = await res.json();
    const vals = json && json.values ? json.values : [];

    if (!vals || vals.length === 0) return [];

    // first row = headers
    const headers = vals[0].map(h => h === undefined || h === null ? '' : String(h).trim());

    // map rows -> objects
    const rows = vals.slice(1).map(row => {
      const obj = {};
      for (let i=0;i<headers.length;i++) {
        const key = headers[i] || `Column${i+1}`;
        obj[key] = (row && row[i] !== undefined) ? row[i] : null;
      }
      return obj;
    });

    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };

  /* ---------- Auto-refresh helpers (robust) ---------- */
  let __autoRefreshTimer = null;
  let __lastKnownDriveModified = null;
  let __autoRefreshRunning = false;
  let __autoRefreshInProgress = false;

  async function tryWithRetries(fn, retries = 2, baseDelay = 600) {
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        return await fn();
      } catch (err) {
        if (attempt === retries) throw err;
        const wait = baseDelay * Math.pow(2, attempt);
        console.warn(`tryWithRetries: attempt ${attempt+1} failed, retrying in ${wait}ms`, err);
        await new Promise(r => setTimeout(r, wait));
      }
    }
  }

  async function fetchDriveLastModified() {
    try {
      const token = await getToken();
      if (!token) {
        console.warn("[auto-refresh] no token available for metadata request");
        return null;
      }
      const url = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}?ts=${Date.now()}`;
      console.debug("[auto-refresh] fetching drive metadata:", url);
      const res = await fetchWithRetry(url, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/json",
          "Cache-Control": "no-cache, no-store",
          Pragma: "no-cache"
        }
      }, 2, 600);
      const json = await res.json();
      const last = json && json.lastModifiedDateTime ? json.lastModifiedDateTime : null;
      console.debug("[auto-refresh] lastModifiedDateTime:", last);
      return last;
    } catch (err) {
      console.warn("fetchDriveLastModified failed:", err);
      return null;
    }
  }

  async function callLoaderWithRetries(email, maxRetries = 2) {
    if (!email) {
      console.warn("callLoaderWithRetries: no email provided");
      return;
    }
    // prefer global exposed loader if exists
    const loader = typeof window.loadLiveDataFor === "function" ? window.loadLiveDataFor : (typeof loadLiveDataFor === "function" ? loadLiveDataFor : null);
    if (!loader) {
      console.warn("callLoaderWithRetries: loader not available (not exposed globally)");
      return;
    }
    await tryWithRetries(async () => {
      console.info(`[auto-refresh] calling loader for ${email}`);
      await loader(email);
      console.info("[auto-refresh] loader succeeded for", email);
    }, maxRetries, 800);
  }

  function startAutoRefresh(intervalMs = 60000) {
    stopAutoRefresh();
    __autoRefreshRunning = true;
    __lastKnownDriveModified = null;

    (async () => {
      try {
        __lastKnownDriveModified = await fetchDriveLastModified();
        console.debug("[auto-refresh] initial lastModified:", __lastKnownDriveModified);
      } catch (e) {
        console.warn("[auto-refresh] initial metadata fetch failed:", e);
      }
    })();

    __autoRefreshTimer = setInterval(async () => {
      if (!__autoRefreshRunning) return;
      if (__autoRefreshInProgress) return;
      __autoRefreshInProgress = true;

      try {
        const last = await fetchDriveLastModified();

        if (last === null) {
          console.debug("[auto-refresh] metadata fetch returned null; skipping this tick.");
          return;
        }

        if (!__lastKnownDriveModified) {
          console.debug("[auto-refresh] setting lastKnown to", last);
          __lastKnownDriveModified = last;
          return;
        }

        if (last !== __lastKnownDriveModified) {
          console.info("[auto-refresh] Drive changed:", __lastKnownDriveModified, "=>", last);
          __lastKnownDriveModified = last;

          const email = window.currentSignedInEmailForAutoRefresh ||
            (window.msalOneDrive && window.msalOneDrive.getAccount && (() => {
              const acct = window.msalOneDrive.getAccount();
              return acct && (acct.username || acct.email || (acct.idTokenClaims && acct.idTokenClaims.preferred_username));
            })());

          if (email) {
            const emailStr = ('' + email).toLowerCase();
            try {
              await callLoaderWithRetries(emailStr, 2);
            } catch (loaderErr) {
              console.error("[auto-refresh] loader still failed after retries:", loaderErr);
            }
          } else {
            console.warn("[auto-refresh] no signed-in email found to call loader with");
          }
        } else {
          console.debug("[auto-refresh] no change detected");
        }
      } catch (err) {
        console.warn("auto refresh tick error:", err);
      } finally {
        __autoRefreshInProgress = false;
      }
    }, intervalMs);
  }

  function stopAutoRefresh() {
    __autoRefreshRunning = false;
    if (__autoRefreshTimer) {
      clearInterval(__autoRefreshTimer);
      __autoRefreshTimer = null;
    }
    __autoRefreshInProgress = false;
  }

</script>

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;
const APPLY_LEAVE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf0k4lKKmwB8LWmzPxEb07Q_X-zT8-sSDghHl79wHvtXLSDeA/viewform";
// TEMP LINKS â€“ replace later
const MARK_ATTENDANCE_URL = "https://script.google.com/a/macros/globalbasesourcing.com/s/AKfycbzqqbsaeEpvXupmGG8ew95qckMPPRY3CyhJu1Fwn5jHR6ugAIrow6eSjNSRrAihxxiaCA/exec";
const IT_HELP_TICKET_URL = "https://docs.google.com/forms/d/e/1FAIpQLScDeECNtU4AY66ExE7nP2k_fGoA0iz9jFpSMxvaZDeSsNtP7Q/viewform";
const HIRING_REQUEST_URL = "https://docs.google.com/forms/d/e/1FAIpQLSemLc4jVjHElByCmLZPZM6VvgTvs9blMMUIHi-2dO3lQdWVSw/viewform";
const MONTHLY_FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfuKxR0xg60CaTSpQDa2XAt9qcdQQMy37Vkryy1mX5N6xdbiA/viewform";
const COMPANY_POLICIES_URL = "https://gbslhk-my.sharepoint.com/:p:/g/personal/hr_globalbasesourcing_com/IQApL-QNk4FES6MunLz973sMAQiEVChFJVnYHYrRPBQPh0M?e=mNe56H";

/* ---------- Excel Date / Time Helpers ---------- */
function excelSerialToDate(value){
  const base = new Date(Date.UTC(1899, 11, 30));
  return new Date(base.getTime() + value * 86400000);
}

function formatExcelDate(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const date = excelSerialToDate(value);
    return date.toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric"
    });
  }
  return String(value);
}

function formatExcelTime(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    return String(hours).padStart(2,"0") + ":" + String(minutes).padStart(2,"0");
  }
  return String(value);
}

function formatExcelDuration(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return (
      String(hours).padStart(2,"0") + ":" +
      String(minutes).padStart(2,"0") + ":" +
      String(seconds).padStart(2,"0")
    );
  }
  return String(value);
}

function formatDisplayDate(value) {
  if (value === null || value === undefined || value === "") return "â€”";

  let date = null;

  if (typeof value === "number") {
    // Excel serial
    date = excelSerialToDate(value);
  } else {
    const d = new Date(value);
    if (!isNaN(d)) date = d;
  }

  if (!date) return String(value);

  const day = String(date.getDate()).padStart(2, "0");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const month = months[date.getMonth()];
  const year = date.getFullYear();

  return `${day}-${month}-${year}`;  // dd-MMM-yyyy
}

/* ------------ Login Card ------------ */
function LoginPage({ onSignIn, error }) {
  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>HR & Admin Dashboard</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Sign in with Microsoft 365</div>
        </div>

        <h2 style={{marginTop:6}}>Sign in</h2>
        <p className="small">
          Global Base â€” HR & Admin Dashboard
        </p>

        {error && (
          <div style={{color:'#dc2626',fontSize:13,marginTop:10}}>
            {error}
          </div>
        )}

        <div style={{marginTop:18}}>
          <button type="button" className="btn" onClick={onSignIn} style={{width:'100%'}}>
            Sign in with Microsoft 365
          </button>
        </div>

        <footer style={{marginTop:16}} className="small muted">
          Your email is only used to Login in Employees Dashboard.
        </footer>
      </div>
    </div>
  );
}

/* ------------ Sidebar (desktop) ------------ */
function Sidebar({ current, onSelect, onLogout, user, employees, selectedEmployeeEmail, setSelectedEmployeeEmail }) {
  const tabs = ['Dashboard','Weekly Agenda','Attendance','Leaves','Profile'];
  return (
    <div className="sidebar">
      <div>
        <div className="logo">
          <img
            src="gbsl.png"  // put your logo URL or relative path
            alt="Global Base"
            className="logo-img"
          />
          <span></span>
        </div>
        <div className="muted">HR & Admin Dashboard</div>
      </div>
      <div className="nav">
        {tabs.map(t=>(
          <button
            key={t}
            className={current===t ? 'active' : ''}
            onClick={()=>onSelect(t)}
          >
            {t}
          </button>
        ))}
      </div>
      <div style={{marginTop:16}}>
  <div className="small muted" style={{marginBottom:6}}>Filter Employee</div>

  <select
    className="search"
    style={{width:'100%'}}
    value={selectedEmployeeEmail}
    onChange={(e)=>setSelectedEmployeeEmail(e.target.value)}
  >
    <option value="">All Employees</option>
    {employees.map(emp => (
      <option key={emp.email} value={emp.email}>
        {emp.name}
      </option>
    ))}
  </select>
</div>

      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
        Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br/>
        <span>{user?.email}</span>
      </div>
      <button onClick={()=>{ try { stopAutoRefresh(); } catch(e){}; onLogout(); }} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}

function KPICard({label, value}) {
  return (
    <div className="kpi">
      <div className="label">{label}</div>
      <div className="value">{value}</div>
    </div>
  );
}
  /* ================= DASHBOARD KPI ================= */
/* ================= DASHBOARD KPI ================= */
function HRKPIs({ employees, attendance, leaves }) {

  const today = new Date();

  function parseDate(val) {
    if (!val) return null;
    const d = new Date(val);
    return isNaN(d) ? null : d;
  }

  const present = attendance.filter(a => {
    const d = parseDate(a.date);
    return d &&
      d.toDateString() === today.toDateString() &&
      a.timeIn &&
      a.timeIn !== "NA";
  }).length;

 const absent = employees.length - present;

  const late = attendance.filter(a => {
    const d = parseDate(a.date);
    return d &&
      d.toDateString() === today.toDateString() &&
      a.lateHours &&
      a.lateHours !== "On Time";
  }).length;

  const onLeave = leaves.filter(l => {
    if (!(l.status || "").toLowerCase().includes("approved")) return false;

    const start = parseDate(l.start);
    const end = parseDate(l.end);

    return start && end && today >= start && today <= end;
  }).length;

  return (
    <div className="kpi-row">
      <KPICard label="Total Employees" value={employees.length} />
      <KPICard label="Present Today" value={present} />
      <KPICard label="Absent Today" value={absent} />
      <KPICard label="On Leave Today" value={onLeave} />
      <KPICard label="Late Today" value={late} />
    </div>
  );
}



/* ================= ATTENDANCE TREND ================= */
function AttendanceChart({ attendance }) {
  const ref = React.useRef();
  const chartRef = React.useRef();

  useEffect(() => {
    const now = new Date();
    const month = now.getMonth();
    const year = now.getFullYear();

    const days = {};

    attendance.forEach(a => {
      if (a.month === month && a.year === year && a.timeIn && a.timeIn.includes(":")) {
        const d = new Date(a.date);
        if (isNaN(d)) return;

        const day = d.getDate();

        const mins =
          Number(a.timeIn.split(":")[0]) * 60 +
          Number(a.timeIn.split(":")[1]);

        days[day] = mins;
      }
    });

    const labels = Object.keys(days).sort((a,b)=>a-b);
    const data = labels.map(l => days[l]);

    if (chartRef.current) chartRef.current.destroy();

    chartRef.current = new Chart(ref.current, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Check-In Time",
          data,
          tension:.3
        }]
      },
options:{
  maintainAspectRatio:false,
  scales:{
    x:{
      title:{display:true, text:"Date of Month"}
    },
    y:{
      min:420,
      max:1200,
      ticks:{
        stepSize:30,
        callback:(val)=>{
          const h=Math.floor(val/60);
          const m=val%60;
          return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
        }
      },
      title:{display:true, text:"Check-In Time"}
    }
  },
  plugins:{
    tooltip:{
      callbacks:{
        label:(ctx)=>{
          const val = ctx.raw;
          const h=Math.floor(val/60);
          const m=val%60;
          return `Check-In Time: ${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
        }
      }
    }
  }
}
});
return () => chartRef.current?.destroy();

  }, [attendance]);

  return <canvas ref={ref}></canvas>;
}
/* ================= LEAVE PIE ================= */
function LeaveChart({ leaves, leaveSummary }) {
  const ref = React.useRef();
  const chartRef = React.useRef();

  useEffect(() => {
    const used =
      leaveSummary.usedCL + leaveSummary.usedSL;

    const allowed =
      leaveSummary.allottedCL + leaveSummary.allottedSL;

    if (chartRef.current) chartRef.current.destroy();

    chartRef.current = new Chart(ref.current, {
      type: "pie",
      data: {
        labels: ["Used", "Remaining"],
        datasets: [{ data: [used, allowed-used] }]
      },
      options:{
        maintainAspectRatio:false,
        responsive:true
      }
    });
  }, [leaveSummary]);

  return <canvas ref={ref}></canvas>;
}


/* ================= TASK STATUS ================= */
function TaskChart({ agenda }) {
  const ref = React.useRef();
  const chartRef = React.useRef();

  useEffect(() => {
    if (!agenda.length) return;

    let complete = 0, pending = 0;

    agenda.forEach(t => {
      Number(t.completionPercent) >= 100 ? complete++ : pending++;
    });

    if (chartRef.current) chartRef.current.destroy();

    chartRef.current = new Chart(ref.current, {
      type: "doughnut",
      data: {
        labels: ["Completed", "Pending"],
        datasets: [{ data: [complete, pending] }]
      },
      options:{
        maintainAspectRatio:false,
        responsive:true
      }
    });

    return () => chartRef.current?.destroy();
  }, [agenda]);

  return <canvas ref={ref}></canvas>;
}

 
function parseDate(val) {
  if (!val) return null;
  const d = new Date(val);
  return isNaN(d) ? null : d;
}


  function HRLists({ employees, attendance }) {

const today = new Date();

  const getEmp = email =>
    employees.find(e =>
  e.email?.toLowerCase() === email?.toLowerCase()
);

 const presentEmails = attendance
  .filter(a=>{
    const d=parseDate(a.date);
    return d &&
      d.toDateString()===today.toDateString() &&
      a.timeIn && a.timeIn!=="NA";
  })
  .map(a=>a.employeeEmail?.toLowerCase());

const absentToday = employees.filter(emp =>
  !presentEmails.includes(emp.email?.toLowerCase())
);

  const lateToday = attendance.filter(a => {
  const d = parseDate(a.date);
  return (
    d &&
    d.toDateString() === today.toDateString() &&
    a.lateHours &&
    a.lateHours !== "On Time"
  );
});


  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();

  const lateMap = {};
 attendance.forEach(a => {
  if (a.month === month && a.year === year && a.timeIn && a.timeIn.includes(":")) {

    const mins =
      Number(a.timeIn.split(":")[0]) * 60 +
      Number(a.timeIn.split(":")[1]);

    if (mins > 605) {
      lateMap[a.employeeEmail] =
        (lateMap[a.employeeEmail] || 0) + 1;
    }
  }
});


  const mostLate = Object.entries(lateMap)
    .map(([email, count]) => ({ email, count }))
    .sort((a, b) => b.count - a.count);

  return (
    <div className="row">

      <div className="card" style={{flex:1}}>
        <strong>Absent Today</strong>
        <table>
         <tbody>
  {absentToday.map((emp,i)=>(
    <tr key={i}>
      <td>{emp.name}</td>
      <td>{emp.department}</td>
    </tr>
  ))}
</tbody>
        </table>
      </div>

      <div className="card" style={{flex:1}}>
        <strong>Late Today</strong>
        <table>
          <tbody>
            {lateToday.map((a,i)=>{
              const emp = getEmp(a.employeeEmail);
              return (
                <tr key={i}>
                  <td>{emp?.name}</td>
                  <td>{a.timeIn}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      <div className="card" style={{flex:1}}>
        <strong>Most Late This Month</strong>
        <table>
          <tbody>
            {mostLate.map((r,i)=>{
              const emp = getEmp(r.email);
              return (
                <tr key={i}>
                  <td>{emp?.name}</td>
                  <td>{r.count}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

    </div>
  );
}


/* ================= MAIN DASHBOARD ================= */
function HRDashboard({
  employees,
  attendance,
  leaves,
  agenda,
  leaveSummary,
  fullAttendance   // ðŸ‘ˆ NEW
}) {
  return (
    <>
      <HRKPIs
        employees={employees}
        attendance={attendance}
        leaves={leaves}
      />
      <div className="dashboard-row">

  <div className="card dashboard-card">
    <strong>Attendance Trend</strong>
    <div className="chart-wrapper">
      <AttendanceChart attendance={attendance}/>
    </div>
  </div>

  <div className="card dashboard-card">
    <strong>Leave Distribution</strong>
    <div className="chart-wrapper">
      <LeaveChart leaves={leaves} leaveSummary={leaveSummary}/>
    </div>
  </div>

  <div className="card dashboard-card">
    <strong>Task Completion</strong>
    <div className="chart-wrapper">
      <TaskChart agenda={agenda}/>
    </div>
  </div>

</div>


      <HRLists employees={employees} attendance={fullAttendance} />
    </>
  );
}



/* ------------ Attendance Page ------------ */
function AttendancePage({ attendance, leaves }) {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);
  const lastMonth = lastMonthDate.getMonth();
  const lastMonthYear = lastMonthDate.getFullYear();

  const currentMonthAttendance = attendance.filter(
    a => a.month === currentMonth && a.year === currentYear
  );
  const lastMonthAttendance = attendance.filter(
    a => a.month === lastMonth && a.year === lastMonthYear
  );

  const currentMonthLeaves = leaves.filter(
    l => l.month === currentMonth && l.year === currentYear
  );

  const currentAppliedCount = currentMonthLeaves.length;
  const currentApprovedCount = currentMonthLeaves.filter(
    l => (l.status || '').toLowerCase().includes('approved')
  ).length;

  const totalAppliedDays = leaves.reduce(
    (sum,l)=>sum + (Number(l.appliedDays) || 0),
    0
  );
  const totalApprovedDays = leaves.reduce(
    (sum,l)=>sum + (Number(l.approvedDays) || 0),
    0
  );

  const monthNames = ["January","February","March","April","May","June","July",
    "August","September","October","November","December"];

  function renderAttendanceTable(title, subtitle, rows) {
    return (
      <div className="card">
        <strong>{title}</strong>
        <p className="muted">{subtitle}</p>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Day</th>
              <th>Check In Time</th>
              <th>Check Out Time</th>
              <th>Late Hours</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r,i)=>(
              <tr key={i}>
                <td>{r.date}</td>
                <td>{r.day}</td>
                <td>{r.timeIn}</td>
                <td>{r.timeOut}</td>
                <td
                  style={{
                    color:
                      r.lateHours === "On Time"
                        ? "#16a34a"   // green
                        : r.lateHours
                        ? "#dc2626"   // red
                        : "inherit"
                  }}
                >
                  {r.lateHours}
                </td>
                <td>{r.status}</td>
              </tr>
            ))}
            {rows.length === 0 && (
              <tr>
                <td colSpan="6" className="muted">No records.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    );
  }

  return (
    <div>
      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={currentMonthAttendance.length} />
        <KPICard label="Applied Leaves" value={totalAppliedDays} />
        <KPICard label="Approved Leaves" value={totalApprovedDays} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          {renderAttendanceTable(
            `${monthNames[currentMonth]} ${currentYear} Attendance`,
            "This month attendance records",
            currentMonthAttendance
          )}
          {renderAttendanceTable(
            `${monthNames[lastMonth]} ${lastMonthYear} Attendance`,
            "Last month attendance records",
            lastMonthAttendance
          )}
        </div>

        <div className="card summary-card">
          <strong>Summary</strong>
          <p className="muted">Quick view</p>
          <div className="summary-row">
            <span>Current month days</span>
            <span>{currentMonthAttendance.length}</span>
          </div>
          <div className="summary-row">
            <span>Last month days</span>
            <span>{lastMonthAttendance.length}</span>
          </div>
          <div className="summary-row">
            <span>Current applied leaves</span>
            <span>{currentAppliedCount}</span>
          </div>
          <div className="summary-row">
            <span>Current approved leaves</span>
            <span>{currentApprovedCount}</span>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ------------ Leaves Page ------------ */
function LeavesPage({ leaves, leaveSummary }) {
  const [statusFilter, setStatusFilter] = React.useState("All");
  const filteredLeavesList = leaves.filter(l => {
  // ðŸ”´ Ignore blank rows from Excel
  if (!l.start && !l.employeeId) return false;

  const status = (l.status || "").toLowerCase();

  if (statusFilter === "Pending")
    return status === "" || status === "pending";

  if (statusFilter === "Approved")
    return status.includes("approved");

  return true;
});

  const {
    allottedCL, allottedSL,
    usedCL, usedSL,
    availableCL, availableSL
  } = leaveSummary || {};

  return (
    <div>
      <div className="card">
        <strong>Paid Leave Calculation</strong>
        <table>
          <thead>
            <tr>
              <th>Leave</th>
              <th>Casual Leave (CL)</th>
              <th>Sick Leave (SL)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Allotted Leave</td>
              <td>{allottedCL ?? 0}</td>
              <td>{allottedSL ?? 0}</td>
            </tr>
            <tr>
              <td>Used Leave</td>
              <td>{usedCL ?? 0}</td>
              <td>{usedSL ?? 0}</td>
            </tr>
            <tr>
              <td>Available Leave</td>
              <td>{availableCL ?? 0}</td>
              <td>{availableSL ?? 0}</td>
            </tr>
          </tbody>
        </table>
        <div style={{marginTop:8, color:'#b91c1c', fontSize:13}}>
          Note:- Each month, 0.5 days of Sick Leave and 0.5 days of Casual Leave are credited to your account.
          Advance leave is not provided. You can save your leave days to take them together.
        </div>
      </div>

      <div className="card">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
  <strong>My Leaves</strong>

  <div style={{display:'flex', gap:10}}>
    <select
      className="search"
      style={{width:140}}
      value={statusFilter}
      onChange={(e)=>setStatusFilter(e.target.value)}
    >
      <option value="All">All</option>
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
    </select>
  </div>
</div>

        <table>
          <thead>
            <tr>
              <th>From</th>
<th>To</th>
<th>Leave Type</th>
<th>Applied Number of working days</th>
<th>Status</th>
<th>Approved Number of days</th>
<th>Approval Link</th>

            </tr>
          </thead>
          <tbody>
            {filteredLeavesList.map((l,i)=>(
              <tr key={i}>
               <td>{l.start}</td>
<td>{l.end}</td>
<td>{l.type}</td>
<td>{l.appliedDays}</td>
<td>{l.status || "Pending"}</td>
<td>{l.approvedDays}</td>
<td>
  {l.approvalLink ? (
    <a href={l.approvalLink} target="_blank">Open</a>
  ) : "â€”"}
</td>

              </tr>
            ))}
            {leaves.length === 0 && (
              <tr>
                <td colSpan="5" className="muted">No leave records.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Weekly Agenda Page ------------ */
function WeeklyAgendaPage({ items }) {
  return (
    <div>
      <div className="card">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <strong>Weekly Agenda</strong>
        </div>
        <table>
          <thead>
            <tr>
              <th>Task No</th>
              <th>Task Details</th>
              <th>Assigner Email Id</th>
              <th>Assignee Email Id</th>
              <th>Initial Target Date</th>
              <th>Submission Type</th>
              <th>Completion Status %</th>
              <th>Update Remarks</th>
              <th>Completion Date</th>
              <th>Update Link</th>
            </tr>
          </thead>
          <tbody>
            {items.map((r,i)=>(
              <tr key={i}>
                <td>{r.taskNo}</td>
                <td>{r.taskDetails}</td>
                <td>{r.assignerEmail}</td>
                <td>{r.assigneeEmail}</td>
                <td>{r.initialTarget}</td>
                <td>{r.submissionType}</td>
                <td>{r.completionPercent}</td>
                <td>{r.updateRemarks}</td>
                <td>{r.completionDate}</td>
                <td>
                  {r.updateLink ? (
                    <a href={r.updateLink} target="_blank" rel="noopener noreferrer">Open</a>
                  ) : "â€”"}
                </td>
              </tr>
            ))}
            {items.length === 0 && (
              <tr>
                <td colSpan="18" className="muted">No tasks assigned.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Profile Page ------------ */
function ProfilePage({ employee }) {
  if(!employee) {
    return (
      <div className="card">
        Employee not found in Excel. Check Employees table for your email.
      </div>
    );
  }

  const initials = employee.name
    ? employee.name.split(' ').map(n=>n[0]).slice(0,2).join('')
    : '';

  return (
    <div className="profile-layout">
      <div className="card profile-card">
        <div style={{display:'flex',alignItems:'center',marginBottom:16}}>
          <div className="profile-avatar">
            {employee.photoUrl ? (
              <img src={employee.photoUrl} alt={employee.name} />
            ) : (
              <div style={{
                width:'100%',height:'100%',display:'flex',
                alignItems:'center',justifyContent:'center',
                fontSize:36,fontWeight:700,color:'var(--accent)'
              }}>
                {initials}
              </div>
            )}
          </div>
          <div>
            <div style={{fontSize:20,fontWeight:700}}>{employee.name}</div>
            <div className="muted">{employee.designation || 'Employee'} &bull; {employee.department || 'â€”'}</div>
            <div className="small" style={{marginTop:4}}>Emp ID: {employee.id}</div>
            {employee.awards && (
              <div className="small">Awards: {employee.awards}</div>
            )}
          </div>
        </div>

        <div className="profile-grid">
          <div className="profile-label">DOJ</div>
          <div>{formatDisplayDate(employee.doj)}</div>

          <div className="profile-label">Email Address</div>
          <div>{employee.email}</div>

          <div className="profile-label">Contact</div>
          <div>{employee.mobile || "â€”"}</div>

          <div className="profile-label">Department</div>
          <div>{employee.department || "â€”"}</div>

          <div className="profile-label">Designation</div>
          <div>{employee.designation || "â€”"}</div>

          <div className="profile-label">Skills & Expertise</div>
          <div>{employee.skills || "â€”"}</div>

          <div className="profile-label">Country</div>
          <div>{employee.country || "â€”"}</div>

          <div className="profile-label">Birth date</div>
          <div>{formatDisplayDate(employee.birthDate)}</div>
        </div>
      </div>

      <div className="card profile-card">
        <strong>Quick Actions</strong>
        <div className="qa-buttons">
          <button
            className="btn"
            onClick={() => window.open(MARK_ATTENDANCE_URL, "_blank")}
          >
            Mark Attendance
          </button>

          <button
            className="btn"
            onClick={() => window.open(APPLY_LEAVE_URL, "_blank")}
          >
            Apply Leave
          </button>

          <button
            className="btn"
            onClick={() => window.open(IT_HELP_TICKET_URL, "_blank")}
          >
            IT Help Ticket
          </button>

          <button
            className="btn"
            onClick={() => window.open(HIRING_REQUEST_URL, "_blank")}
          >
            Raise Hiring Request
          </button>

          <button
            className="btn"
            onClick={() => window.open(MONTHLY_FEEDBACK_URL, "_blank")}
          >
            GBSL Monthly Feedback
          </button>

          <button
            className="btn"
            onClick={() => window.open(COMPANY_POLICIES_URL, "_blank")}
          >
            Company Policies
          </button>
        </div>

      </div>
    </div>
  );
}

/* ------------ App ------------ */
function App() {
  const [user, setUser] = useState(null);          // { email, name }
  const [activeTab, setActiveTab] = useState('Weekly Agenda');
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [weeklyAgenda, setWeeklyAgenda] = useState([]);
  const [selectedEmployeeEmail, setSelectedEmployeeEmail] = useState("");
  const [leaveCalcData, setLeaveCalcData] = useState([]);
  const [leaveSummary, setLeaveSummary] = useState({
    allottedCL:0, allottedSL:0,
    usedCL:0, usedSL:0,
    availableCL:0, availableSL:0
  });
  const [currentEmployee, setCurrentEmployee] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Mobile sidebar open state (only added to enable phone menu)
  const [mobileSidebarOpen, setMobileSidebarOpen] = useState(false);

  function normalize(str) {
    return (str || '').toString().trim().toLowerCase();
  }

  // Rehydrate MSAL account on app mount so page reloads keep the user signed in
  useEffect(() => {
    (async () => {
      try {
        const acct = window.msalOneDrive && window.msalOneDrive.getAccount ? window.msalOneDrive.getAccount() : null;
        if (acct) {
          const email =
            (acct.username ||
             acct.email ||
             (acct.idTokenClaims && acct.idTokenClaims.preferred_username) ||
             "").toLowerCase();
          const name = acct.name || email;
          setUser({ email, name });
          window.currentSignedInEmailForAutoRefresh = email;
          // attempt to load data silently (getToken will try silent)
          await loadLiveDataFor(email);
          // start auto refresh (every 60s)
          startAutoRefresh(60000);
        } else {
          console.debug("[auth] no stored MSAL account on mount.");
        }
      } catch (e) {
        console.warn("[auth] rehydrate failed:", e);
      }
    })();
  }, []);

  async function handleMsSignIn() {
    try {
      setError('');
      await window.msalOneDrive.loginPopup();
      const account = window.msalOneDrive.getAccount();
      if (!account) {
        setError('Unable to get Microsoft account after login.');
        return;
      }
      const email =
        (account.username ||
         account.email ||
         (account.idTokenClaims && account.idTokenClaims.preferred_username) ||
         '').toLowerCase();

      const name = account.name || email;
      setUser({ email, name });
      setActiveTab('Weekly Agenda');

      // expose for auto-refresh to use
      window.currentSignedInEmailForAutoRefresh = email;

      // load data for user (this uses the in-component loader)
      await loadLiveDataFor(email);

      // start auto-refresh (60s default)
      startAutoRefresh(60000);

    } catch (e) {
      console.error(e);
      setError('Microsoft sign-in failed. See console for details.');
    }
  }

  async function loadLiveDataFor(userEmail) {
    // mutex to avoid overlapping calls
    if (window.__loadLiveDataInProgress) {
      console.debug("loadLiveDataFor: already running, skipping concurrent call");
      return;
    }
    window.__loadLiveDataInProgress = true;

    try {
      setLoading(true);
      setError("");

      const lowerEmail = normalize(userEmail);
      let me = null;

      /* ===== 1) EMPLOYEES TABLE ===== */
      const empRows = await window.fetchOneDriveTable("employees").catch(() => null);
      if (empRows && empRows.length) {
        const mappedEmps = empRows.map((r) => {
          const id =
            r["Employee ID"] ||
            r.EmployeeID ||
            r.employeeId ||
            r["Employee Id"] ||
            r["Emp ID"] ||
            null;

          const primaryEmail =
            r["Microsoft Email ID"] ||
            r["Microsoft Email"] ||
            r.MicrosoftEmailID ||
            null;

          const altEmail =
            r["Email address"] ||
            r["Email Address"] ||
            r.Email ||
            r.email ||
            null;

          return {
            id,
            name: r["Emp Name"] || r.EmpName || r.Name || "",
            email: (primaryEmail || altEmail || "").toString().trim(),
            primaryEmail: (primaryEmail || "").toString().trim(),
            altEmail: (altEmail || "").toString().trim(),
            department: r["Department"] || "",
            designation: r["Designation"] || "",
            skills: r["Skills & Expertise"] || "",
            country: r["Country"] || "",
            birthDate: r["Birth date"] || "",
            awards: r["Awards"] || "",
            photoUrl:
              r["Employee Photo"] ||
              r["EmployeePhoto"] ||
              r["Photo URL"] ||
              r.PhotoUrl ||
              null,
            doj: r.DOJ || r["DOJ"] || "",
            mobile: r.Mobile || r["Mobile"] || null
          };
        });

        me =
          mappedEmps.find(e => normalize(e.primaryEmail) === lowerEmail) ||
          mappedEmps.find(e => normalize(e.altEmail) === lowerEmail) ||
          null;

        // commit employees only when fetched & mapped
        setEmployees(mappedEmps);
        if (me) {
          me = { ...me, email: me.email || me.primaryEmail || me.altEmail };
          setCurrentEmployee(me);
        } else {
          console.warn("No employee row matching email:", lowerEmail, "Check Employees table 'Microsoft Email ID' / 'Email address' columns.");
        }
      } else if (empRows === null) {
        console.warn("Employees fetch failed; preserving previous employees state.");
      } else {
        setEmployees([]);
        setCurrentEmployee(null);
      }

      const myId = me && me.id ? normalize(me.id) : null;
      const myName = me && me.name ? normalize(me.name) : null;

      /* ===== 2) ATTENDANCE TABLE ===== */
      const attRows = await window.fetchOneDriveTable("attendance").catch(() => null);
      if (attRows && attRows.length) {
        let mapped = attRows.map((r) => {
          const rawDate =
            r["Date"] ||
            r.Date ||
            "";

          let jsDate = null;
          if (typeof rawDate === "number") {
            jsDate = excelSerialToDate(rawDate);
          } else if (rawDate) {
            jsDate = new Date(rawDate);
          }

          const rawTimeIn =
            r["Time_In"] ||
            r["Check-IN Time"] ||
            r["Check In Time"] ||
            r.CheckINTime ||
            "";

          const rawTimeOut =
            r["Time_Out"] ||
            r["Check-Out Time"] ||
            r["Check Out Time"] ||
            r.CheckOutTime ||
            "";

          const rawLate =
            r["Late Hours"] ||
            r["Late Hour"] ||
            r.LateHours ||
            "";

          const jsDay = jsDate ? jsDate.toLocaleDateString("en-GB", { weekday:"short" }) : "";

          return {
            employeeEmail:
              r["Email ID"] ||
              r["Email"] ||
              r.EmailID ||
              r.Email ||
              "",
            name: r["Emp Name"] || r.EmpName || "",
            date: formatExcelDate(rawDate),
            day: jsDay,
            status: r["Status"] || r.Status || "",
            timeIn: formatExcelTime(rawTimeIn),
            timeOut: formatExcelTime(rawTimeOut),
            lateHours: formatExcelDuration(rawLate),
            month: jsDate ? jsDate.getMonth() : null,
            year: jsDate ? jsDate.getFullYear() : null
          };
        });
        setAttendance(mapped);        
      } else if (attRows === null) {
        console.warn("Attendance fetch failed; preserving previous attendance state.");
      } else {
        setAttendance([]);
      }

      /* ===== 3) LEAVES TABLE ===== */
      const leavesRows = await window.fetchOneDriveTable("leaves").catch(() => null);
      if (leavesRows && leavesRows.length) {
        let mapped = leavesRows.map((r) => {
          const rawStart =
            r["Start Date"] ||
            r.StartDate ||
            r.Start ||
            "";

          let jsStart = null;
          if (typeof rawStart === "number") {
            jsStart = excelSerialToDate(rawStart);
          } else if (rawStart) {
            jsStart = new Date(rawStart);
          }

          const appliedDays =
            Number(
              r["Applied Number of working days"] ||
              r["Applied Number of days"] ||
              r.AppliedDays ||
              0
            );

          const approvedDays =
            Number(
              r["Approved Number of days"] ||
              r["Approved Days"] ||
              r["Paid Days"] ||
              r.PaidDays ||
              0
            );

          return {
            employeeId:
              r["Employee Id"] ||
              r["Employee ID"] ||
              r.EmployeeId ||
              r.EmployeeID ||
              null,
            name: r["Name"] || r.Name || "",
            start: formatExcelDate(rawStart),
            end: formatExcelDate(
              r["End Date"] || r.EndDate || r.End || ""
            ),
            type: r["Leave Type"] || r.LeaveType || "",
            status: r["Approval Decision"] || r.ApprovalDecision || "",
            approvalLink: r["Approval Link"] || r.ApprovalLink || "",
            appliedDays,
            approvedDays,
            month: jsStart ? jsStart.getMonth() : null,
            year: jsStart ? jsStart.getFullYear() : null
          };
        });

       setLeaves(mapped);

      } else if (leavesRows === null) {
        console.warn("Leaves fetch failed; preserving previous leaves state.");
      } else {
        setLeaves([]);
      }

      
   /* ===== 4) LEAVE CALCULATION TABLE ===== */
const calcRows = await window.fetchOneDriveTable("leaveCalc").catch(()=>null);

if (calcRows && calcRows.length) {
  setLeaveCalcData(calcRows);

  // reset summary (actual filtering happens later)
  setLeaveSummary({
    allottedCL:0, allottedSL:0,
    usedCL:0, usedSL:0,
    availableCL:0, availableSL:0
  });

} else if (calcRows === null) {
  console.warn("leaveCalc fetch failed; preserving leaveSummary.");
} else {
  setLeaveCalcData([]);
  setLeaveSummary({
    allottedCL:0, allottedSL:0,
    usedCL:0, usedSL:0,
    availableCL:0, availableSL:0
  });
}

      /* ===== 5) WEEKLY AGENDA TABLE ===== */
      const agendaRows = await window.fetchOneDriveTable("weeklyAgenda").catch(()=>null);
      if (agendaRows && agendaRows.length) {
        let mapped = agendaRows.map(r => ({
          taskNo: r["Task No"] || r.TaskNo || "",
          taskDetails: r["Task Details"] || r.TaskDetails || "",
          assignerEmail: r["Assigner Email Id"] || r.AssignerEmailId || "",
          assigneeEmail: r["Assignee Email Id"] || r.AssigneeEmailId || "",
          initialTarget: formatExcelDate(r["Initial Target Date"] || r.InitialTargetDate || ""),
          submissionType: r["Submission Type"] || r.SubmissionType || "",
          completionPercent: r["Completion Status %"] || r.CompletionStatus || "",
          updateRemarks: r["Update Remarks"] || r.UpdateRemarks || "",
          completionDate: formatExcelDate(r["Completion Date"] || r.CompletionDate || ""),
          updateLink: r["Update Link"] || r.UpdateLink || ""
        }));

        setWeeklyAgenda(mapped);

      } else if (agendaRows === null) {
        console.warn("weeklyAgenda fetch failed; preserving previous weeklyAgenda.");
      } else {
        setWeeklyAgenda([]);
      }

    } catch (err) {
      console.error("Live data load failed", err);
      setError("Error loading data from Excel. Check console for details.");
    } finally {
      setLoading(false);
      window.__loadLiveDataInProgress = false;
    }
  }

  // expose to auto-refresh world:
  window.loadLiveDataFor = loadLiveDataFor;

  // NEW: robust logout which calls MSAL logout and clears local app state
  async function handleLogout() {
    try {
      // stop auto-refresh first
      try { stopAutoRefresh(); } catch(e) { /* ignore */ }

      // get current MSAL account (may be null)
      const acct = window.msalOneDrive && window.msalOneDrive.getAccount ? window.msalOneDrive.getAccount() : null;

      // Clear app state locally (React)
      setUser(null);
      setCurrentEmployee(null);
      setEmployees([]); setAttendance([]); setLeaves([]); setWeeklyAgenda([]);
      setActiveTab('Attendance');

      // Clear any helper pointer used by auto-refresh
      window.currentSignedInEmailForAutoRefresh = null;

      // If there's an MSAL account, call logout to clear MSAL cache / tokens.
      if (acct) {
        try {
          // Try popup logout (better UX) â€” some browsers block popups
          await msalInstance.logoutPopup({ account: acct, mainWindowRedirectUri: REDIRECT_URI });
        } catch (popupErr) {
          console.warn("logoutPopup failed or blocked, falling back to redirect logout:", popupErr);
          // fallback to redirect logout (this will navigate away and return to redirectUri)
          try {
            msalInstance.logoutRedirect({ account: acct, postLogoutRedirectUri: REDIRECT_URI });
            // Note: logoutRedirect will redirect away; the following lines may not run.
          } catch (redirectErr) {
            console.error("logoutRedirect also failed:", redirectErr);
          }
        }
      } else {
        // No MSAL account present â€” still ensure localStorage items that MSAL uses are cleared
        try {
          Object.keys(localStorage).forEach(k => {
            if (k && k.indexOf("msal") === 0) localStorage.removeItem(k);
          });
        } catch (e) { /* ignore */ }
      }
    } catch (err) {
      console.error("Error during logout:", err);
      // ensure local UI cleared even if logout call failed
      setUser(null);
      setCurrentEmployee(null);
      setEmployees([]); setAttendance([]); setLeaves([]); setWeeklyAgenda([]);
      setActiveTab('Attendance');
      window.currentSignedInEmailForAutoRefresh = null;
      try { stopAutoRefresh(); } catch(e){ }
    }
  }

  if (!user) {
    return <LoginPage onSignIn={handleMsSignIn} error={error} />;
  }

  const employee = currentEmployee || (employees.length ? employees[0] : null);
const filteredAttendance = selectedEmployeeEmail
  ? attendance.filter(a => normalize(a.employeeEmail) === normalize(selectedEmployeeEmail))
  : attendance;

const selectedEmp = employees.find(e => e.email === selectedEmployeeEmail);

const filteredLeaves = selectedEmp
  ? leaves.filter(l => normalize(l.employeeId) === normalize(selectedEmp.id))
  : leaves;

const filteredAgenda = selectedEmployeeEmail
  ? weeklyAgenda.filter(a => normalize(a.assigneeEmail) === normalize(selectedEmployeeEmail))
  : weeklyAgenda;
let filteredLeaveSummary = leaveSummary;

if (selectedEmployeeEmail) {
  const emp = employees.find(e => e.email === selectedEmployeeEmail);

  if (emp) {
    const row = leaveCalcData.find(r =>
      normalize(r["Employee Id"] || r["Employee ID"]) === normalize(emp.id)
    );

    if (row) {
      const totalLeaves = Number(row["Total Leaves"] || 0);
      const half = totalLeaves / 2;
      const usedCL = Number(row["Casual Leave (CL)"] || 0);
      const usedSL = Number(row["Sick Leave (SL)"] || 0);

      filteredLeaveSummary = {
        allottedCL: half,
        allottedSL: half,
        usedCL,
        usedSL,
        availableCL: half - usedCL,
        availableSL: half - usedSL
      };
    }
  }
}

  return (
    <div className="app">
      {/* Desktop sidebar */}
      <Sidebar
  current={activeTab}
  onSelect={setActiveTab}
  onLogout={handleLogout}
  user={user}
  employees={employees}
  selectedEmployeeEmail={selectedEmployeeEmail}
  setSelectedEmployeeEmail={setSelectedEmployeeEmail}
/>


      {/* Mobile overlay sidebar (only shown on small screens) */}
      <div className={`mobile-sidebar-backdrop ${mobileSidebarOpen ? 'open' : ''}`} onClick={()=>setMobileSidebarOpen(false)} />
      <aside className={`mobile-sidebar ${mobileSidebarOpen ? 'open' : ''}`} aria-hidden={!mobileSidebarOpen}>
        <div style={{display:'flex', justifyContent:'flex-end'}}>
          <button onClick={()=>setMobileSidebarOpen(false)} style={{background:'transparent', border:'none', cursor:'pointer', fontSize:20}}>âœ•</button>
        </div>

        <div>
          <div className="logo">
            <img src="gbsl.png" alt="Global Base" className="logo-img" />
            <span></span>
          </div>
          <div className="muted">HR & Admin Dashboard</div>
        </div>

        <div className="nav" style={{marginTop:12}}>
          {['Weekly Agenda','Attendance','Leaves','Profile'].map(t=>(
            <button key={t} className={activeTab===t ? 'active' : ''} onClick={() => { setActiveTab(t); setMobileSidebarOpen(false); }}>
              {t}
            </button>
          ))}
        </div>

        <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
          Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br/>
          <span>{user?.email}</span>
        </div>
        <button onClick={() => { try { stopAutoRefresh(); } catch(e){}; setMobileSidebarOpen(false); handleLogout(); }} className="btn" style={{width:'100%'}}>Sign out</button>
      </aside>

      <div className="main">
        <div className="header">
          <div style={{display:'flex', alignItems:'center', gap:12}}>
            {/* Hamburger only visible on mobile via CSS */}
            <button className="hamburger" onClick={()=>setMobileSidebarOpen(true)} aria-label="Open menu">
              <span className="bar" />
            </button>

            <div>
              <div style={{fontSize:22,fontWeight:700}}>Global Base â€” HR & Admin Dashboard</div>
              <div className="muted">Data for <strong>{user.email}</strong></div>
            </div>
          </div>
  <div style={{display:'flex', gap:12, alignItems:'center'}}>
  {loading && <div className="small muted">Refreshing dataâ€¦</div>}
</div>


        </div>
{activeTab === 'Dashboard' && (
 <HRDashboard
  employees={employees}
  attendance={filteredAttendance}      // for charts & KPIs
  fullAttendance={attendance}           // for tables (constant)
  leaves={filteredLeaves}
  agenda={filteredAgenda}
  leaveSummary={filteredLeaveSummary}
/>
)}

        {activeTab === 'Attendance' && (
          <AttendancePage attendance={filteredAttendance} leaves={filteredLeaves} />

        )}
        {activeTab === 'Leaves' && (
          <LeavesPage leaves={filteredLeaves} leaveSummary={filteredLeaveSummary} />


        )}
        {activeTab === 'Weekly Agenda' && (
          <WeeklyAgendaPage items={filteredAgenda} />

        )}
        {activeTab === 'Profile' && (
          <ProfilePage employee={employee} />
        )}

        <footer>
          <div className="muted">
            Global Base â€” HR & Admin Dashboard Created by GBSL IT.
          </div>
        </footer>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>







